#!/usr/bin/env bash

# sudo apt install xtables-addons-common libtext-csv-xs-perl libmoosex-types-netaddr-ip-perl
# sudo modprobe xt_geoip
# sudo iptables -A DOCKER-USER -m geoip -p tcp --dport 80 --src-cc KR -j DROP
#
# fix: modprobe: FATAL: Module xt_geoip not found in directory /lib/modules/5.13.0-1030-oracle
# sudo apt install module-assistant
# module-assistant --verbose --text-mode auto-install xtables-addons
#
# Can't locate Debian/Debhelper/Sequence/dkms.pm
# apt install dh-dkms
#
# WSL2
# https://unix.stackexchange.com/a/645131
# https://github.com/microsoft/WSL/issues/9693#issuecomment-1450468035
# sudo m-a -k /usr/src/linux -l 5.15.0-101-generic --verbose --text-mode a-i xtables-addons

geoip_mods(){
    echo "Iptables Modules"
    echo "-------------------------------------"
    cat /proc/net/ip_tables_matches
    echo "-------------------------------------"
    echo "Module                  Size  Used by"
    lsmod | grep ^xt_geoip
}

geoip_update(){
    cd ${GEOIP_DIR}
    # /usr/lib/xtables-addons
    # /usr/libexec/xtables-addons
    check_root /usr/libexec/xtables-addons/xt_geoip_dl
    [[ ! -d /usr/share/xt_geoip ]] && mkdir -p /usr/share/xt_geoip
    check_root /usr/libexec/xtables-addons/xt_geoip_build -s
    discord_send "GeoIPs have been updated."
}

geoip_manager(){
    case "${1}" in
        "mods")
            geoip_mods
            ;;
        "update")
            geoip_update
            ;;
        *) log E "예시 : ${NAME} geoip [mods|update]" ;;
    esac
}